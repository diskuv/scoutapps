# Recommendation: Place this file in source control.
# Auto-generated by `./dk dksdk.project.new` of SquirrelScout.
#
# The only tests you should add here are ones that work
# regardless whether CMake is cross-compiling.

include(DkSDKDetectExecutables)

if(DKSDK_EXECUTABLE_FILE)
    # Check, for each given target ABI, whether you compiled the expected
    # file architecture. Use `file XXX.exe` to inspect the file
    # architecture.
    set(test1_pass_regex)

    if(CMAKE_OCamlDune_TARGET_ABI STREQUAL "android_arm32v7a")
        set(test1_pass_regex [[ELF 32-bit LSB pie executable, ARM, EABI5 version 1]])
    elseif(CMAKE_OCamlDune_TARGET_ABI STREQUAL "android_arm64v8a")
        set(test1_pass_regex [[ELF 64-bit LSB pie executable, ARM aarch64, version 1]])
    elseif(CMAKE_OCamlDune_TARGET_ABI STREQUAL "android_x86_64")
        set(test1_pass_regex [[ELF 64-bit LSB pie executable, x86-64, version 1]])
    elseif(CMAKE_OCamlDune_TARGET_ABI STREQUAL "linux_x86")
        set(test1_pass_regex [[ELF 32-bit LSB (pie )?executable, Intel 80386, version 1]])
    elseif(CMAKE_OCamlDune_TARGET_ABI STREQUAL "linux_x86_64")
        set(test1_pass_regex [[ELF 64-bit LSB (pie )?executable, x86-64, version 1]])
    elseif(CMAKE_OCamlDune_TARGET_ABI STREQUAL "windows_x86")
        set(test1_pass_regex [[PE32 executable \(console\) Intel 80386, for MS Windows]])
    elseif(CMAKE_OCamlDune_TARGET_ABI STREQUAL "windows_x86_64")
        set(test1_pass_regex [[PE32\+ executable \(console\) x86-64, for MS Windows]])
    elseif(CMAKE_OCamlDune_TARGET_ABI STREQUAL "darwin_x86_64")
        set(test1_pass_regex [[Mach-O 64-bit executable x86_64]])
    elseif(CMAKE_OCamlDune_TARGET_ABI STREQUAL "darwin_arm64")
        set(test1_pass_regex [[Mach-O 64-bit executable arm64]])
    endif()

    if(test1_pass_regex)
        set(test1 "${PROJECT_NAME}. GIVEN main-cli WHEN inspect with 'file' THEN get architecture")
        add_test(NAME ${test1}
            COMMAND ${DKSDK_EXECUTABLE_FILE} $<TARGET_FILE:main-cli>)
        set_tests_properties(${test1} PROPERTIES
            PASS_REGULAR_EXPRESSION "${test1_pass_regex}"
            ENVIRONMENT "TEST_FILE=${CMAKE_CURRENT_LIST_FILE};TEST_LINE=${CMAKE_CURRENT_LIST_LINE}")
    endif()
endif()
